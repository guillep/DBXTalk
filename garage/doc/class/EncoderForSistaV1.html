<html><head><title>EncoderForSistaV1</title><link rel="stylesheet" type="text/css" href="../files/common.css"/><link rel="stylesheet" type="text/css" href="../files/stcode.css"/><link rel="stylesheet" type="text/css" href="../files/style.css"/><link rel="stylesheet" type="text/css" href="../files/vtip.css"/><script>/*<![CDATA[*/
document.WEBDOC_RELATIVE_DOCUMENT_ROOT ="../..";
document.WEBDOC_PHARO_VERSION ="'4.0'";
/*]]>*/</script><script src="../files/jQuery.js"></script><script src="../files/jQueryUi.js"></script><script src="../files/app.js"></script></head><body onload="onLoad()"><div id="header"><form accept-charset="utf-8" method="get" action="/" class="hidden" id="search"><div class="searchInput">Search: <input accesskey="s" placeholder="search" name="4" id="search_box" size="30" value="" onkeyup="$.ajax({&quot;url&quot;:&quot;/&quot;,&quot;data&quot;:[&quot;1&quot;,&quot;2=&quot;+encodeURIComponent($(&quot;#search_box&quot;).val())].join(&quot;&amp;&quot;)});$(&quot;#searchResults&quot;).load(&quot;/&quot;,&quot;3&quot;)" type="search" class="search"/></div><div id="searchResults"></div><div></div></form></div><div id="content"><h1 class="className">EncoderForSistaV1</h1><dl class="box"><dt>Subclass of: </dt><dd><span class="inheritName"><a class="object_link class_link" target="classView" title="BytecodeEncoder (class)" href="../class/BytecodeEncoder.html">BytecodeEncoder</a></span><ul class="fullTree"><li><a class="object_link class_link" target="classView" title="EncoderForSistaV1 (class)" href="../class/EncoderForSistaV1.html">EncoderForSistaV1</a></li><li class="next"><a class="object_link class_link" target="classView" title="ProtoObject (class)" href="../class/ProtoObject.html">ProtoObject</a></li><li class="next"><a class="object_link class_link" target="classView" title="Object (class)" href="../class/Object.html">Object</a></li><li class="next"><a class="object_link class_link" target="classView" title="ParseNode (class)" href="../class/ParseNode.html">ParseNode</a></li><li class="next"><a class="object_link class_link" target="classView" title="Encoder (class)" href="../class/Encoder.html">Encoder</a></li><li class="next"><a class="object_link class_link" target="classView" title="BytecodeEncoder (class)" href="../class/BytecodeEncoder.html">BytecodeEncoder</a></li></ul><a class="inheritanceTree">&oplus;</a></dd></dl><br/><div class="classComment"><h2 class="title">Overview</h2><div class="docString"><p><a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/EncoderForSistaV1.html">EncoderForSistaV1</a> encodes a bytecode set for Sista, the Speculative Inlining <a class="stGlobalLiteral" href="class/EncoderForSistaV1.html/class/SmalltalkImage.html">Smalltalk</a> Architecture, a project by Cl√©ment Bera and Eliot Miranda.  Sista is an optimizer that exists in the <a class="stGlobalLiteral" href="class/EncoderForSistaV1.html/class/SmalltalkImage.html">Smalltalk</a> image, /not/ in the VM,  and optimizes by substituting normal bytecoded methods by optimized bytecoded methods that may use special bytecodes for which the Cogit can generate faster code.  These bytecodes eliminate overheads such as bounds checks or polymorphic code (indexing <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Array.html">Array</a>, <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/ByteArray.html">ByteArray</a>, <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/String.html">String</a> etc).  But the bulk of the optimization performed is in inlining blocks and sends for the common path.  This bytecode set therefore differs from a normal <a class="stGlobalLiteral" href="class/EncoderForSistaV1.html/class/SmalltalkImage.html">Smalltalk</a> set in providing a set of inlined primitives that do not validate their arguments that the compiler generates only when it can prove that the primitives' arguments are valid.</p><p>The basic scheme is that the Cogit generates code containing performance counters.  When these counters trip, a callback into the image is performed, at which point Sista analyses some portion of the stack, looking at performance data for the methods on the stack, and optimises based on the stack and performance data.  Execution then resumes in the optimized code.</p><p>The Sista Cogit (e.g. SistaStackToRegisterMappingCogit) adds counters to conditional branches.  Each branch has an executed and a taken count.  On execution the executed count is decremented and if the count goes below zero the VM sends a message at a special index in the specialObjectsArray (as of writing, conditionalCounterTrippedOn:).  Then if the branch is taken the taken count is decremented.  The two counter values allow the Sista optimizer to collect basic block execution paths and to know what are the &quot;hot&quot; paths through execution that are worth agressively optimizing.  Since conditional branches are about 1/6 as frequent as sends, and since they can be used to determine the hot path through code, they are a better choice to count than, for example, method or block entry.</p><p>The VM provides a primitive that fills an <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Array.html">Array</a> with the state of the counters, and the state of each linked send in a method.  Tthe optimizer obtains the branch and send data for a method via this primitive.</p><p>This bytecde set encodes a bytecode set for <a class="stGlobalLiteral" href="class/EncoderForSistaV1.html/class/SmalltalkImage.html">Smalltalk</a> that lifts limits on the number of literals and branch distances, and extended push integer and push character bytecodes.  Bytecodes are ordered by length to make decoding easier.  Bytecodes marked with an * are extensible via a prefix bytecode.</p><p>N.B.  Extension bytecodes can only come before extensible bytecodes, and only if valid (one cannot extend a bytecode extensible by Ext A with an Ext B).  An extensible bytecode consumes (and zeros) its extension(s).  Hence the hidden implicit variables holding extensions are always zero except after a valid sequence of extension bytecodes.</p><p>Instance Variables (inherited)</p><p>1 Byte Bytecodes 0-150000 iiii Push Receiver Variable #iiii 16-310001 iiiiPush Literal Variable #iiii 32-63001 iiiiiPush Literal #iiiii 64-7101000 iiiPush Temp #iii 72-75010010 iiPush Temp #ii + 8 7601001100Push Receiver 7701001101Push true 7801001110Push false 7901001111Push nil 8001010000Push 0 8101010001Push 1 *8201010010Push <span class="stThisContext">thisContext</span>, (then Extend B = 1 =&gt; push thisProcess) 8301010011Duplicate <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Stack.html">Stack</a> Top 84-87010101 iiUNASSIGNED 88-91010110 iiReturn Receiver/true/false/nil 9201011100Return top 9301011101BlockReturn nil *9401011110BlockReturn Top <a>* return from enclosing block N, N = Extend A, then jump by Ext B </a> *9501011111Nop 96-1110110 iiiiSend Arithmetic <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Message.html">Message</a> #iiii #(#+ #- #<a href="#"></a> #'&lt;=' #'&gt;=' #= #'~=' #* #/ #'\' #@ #bitShift: #'//' #bitAnd: #bitOr:) 112-11901110 iiiSend Special <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Message.html">Message</a> #iii #(#at: #at:put: #size <a class="stSelector" href="class/EncoderForSistaV1.html/class/GAResultSetReadStream.html#method/next">#next</a> #nextPut: #atEnd #'==' class) 12001111000UNASSIGNED (was: blockCopy:) 12101111001Send Special <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Message.html">Message</a> #value 122-1230111101 iSend Special <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Message.html">Message</a> #i #(#value: #do:) 124-127011111 iiSend Special <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Message.html">Message</a> #ii #(#new #new: #x #y)) 128-1431000 iiiiSend Literal Selector #iiii With 0 Argument 144-1591001 iiiiSend Literal Selector #iiii With 1 Arguments 160-1751010 iiiiSend Literal Selector #iiii With 2 Arguments 176-18310110 iiiJump iii + 1 (i.e., 1 through 8) 184-19110111 iiiPop and Jump 0n <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/True.html">True</a> iii +1 (i.e., 1 through 8) 192-19911000 iiiPop and Jump 0n <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/False.html">False</a> iii +1 (i.e., 1 through 8) 200-20711001 iiiPop and Store Receiver Variable #iii 208-21511010 iiiPop and Store Temporary Variable #iii 21611011000Pop <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Stack.html">Stack</a> Top 21711011001UNASSIGNED 218-2191101101 iUNASSIGNED 220-223110111 iiUNASSIGNED</p><p>2 Byte Bytecodes *22411100000aaaaaaaaExtend A (Ext A = Ext A prev * 256 + Ext A) *22511100001bbbbbbbbExtend B (Ext B = Ext B prev * 256 + Ext B) *22611100010iiiiiiiiPush Receiver Variable #iiiiiiii (+ Extend A * 256) *22711100011iiiiiiiiPush Literal Variable #iiiiiiii (+ Extend A * 256) *22811100100iiiiiiiiPush Literal #iiiiiiii (+ Extend A * 256) 22911100101iiiiiiiiPush Temporary Variable #iiiiiiii 23011100110iiiiiiiiPushNClosureTemps iiiiiiii 23111100111jkkkkkkkPush (Array new: kkkkkkk) (j = 0) &amp;Pop kkkkkkk elements into: (Array new: kkkkkkk) (j = 1) *23211101000iiiiiiiiPush <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Integer.html">Integer</a> #iiiiiiii (+ Extend B * 256, where bbbbbbbb = sddddddd, e.g. -32768 = i=0, a=0, s=1) *23311101001iiiiiiiiPush <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Character.html">Character</a> #iiiiiiii (+ Extend B * 256) **23411101010iiiiijjjSend Literal Selector #iiiii (+ Extend A * 32) with jjj (+ Extend B * 8) Arguments **23511101011iiiiijjjSend To Superclass Literal Selector #iiiii (+ Extend A * 32) with jjj (+ Extend B * 8) Arguments *23611101100iiiiiiiiTrap If Not Instance Of Behavior/Array Of <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Behavior.html">Behavior</a> #iiiiiiii (+ Extend A * 256, where Extend A &gt;= 0) *23711101101iiiiiiiiJump #iiiiiiii (+ Extend B * 256, where bbbbbbbb = sddddddd, e.g. -32768 = i=0, a=0, s=1) *23811101110iiiiiiiiPop and Jump 0n <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/True.html">True</a> #iiiiiiii (+ Extend B * 256, where Extend B &gt;= 0) *23911101111iiiiiiiiPop and Jump 0n <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/False.html">False</a> #iiiiiiii (+ Extend B * 256, where Extend B &gt;= 0) *24011110000iiiiiiiiPop and Store Receiver Variable #iiiiiii (+ Extend A * 256) *24111110001iiiiiiiiPop and Store Literal Variable #iiiiiiii (+ Extend A * 256) 24211110010iiiiiiiiPop and Store Temporary Variable #iiiiiiii *24311110011iiiiiiiiStore Receiver Variable #iiiiiii (+ Extend A * 256) *24411110100iiiiiiiiStore Literal Variable #iiiiiiii (+ Extend A * 256) 24511110110iiiiiiiiStore Temporary Variable #iiiiiiii 246-2471111011 ixxxxxxxxUNASSIGNED</p><p>3 Byte Bytecodes 24811111000 iiiiiiiimjjjjjjjCall Primitive #iiiiiiii + (jjjjjjj * 256) m=1 means inlined primitive, no hard return after execution. 24911111001 xxxxxxxxsyyyyyyyReserved for Push <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/Float.html">Float</a> **25011111010 eeiiikkkjjjjjjjjPush Closure Num Copied iii (+ExtA//16<em>8) Num Args kkk (+ ExtA\16</em>8) BlockSize jjjjjjjj (+ExtB*256). ee = num extensions 25111111011 kkkkkkkkjjjjjjjjPush Temp At kkkkkkkk In Temp Vector At: jjjjjjjj 25211111100 kkkkkkkkjjjjjjjjStore Temp At kkkkkkkk In Temp Vector At: jjjjjjjj 25311111101 kkkkkkkkjjjjjjjjPop and Store Temp At kkkkkkkk In Temp Vector At: jjjjjjjj 254-2551111111ixxxxxxxxyyyyyyyyUNASSIGNED</p><p>The Call Primitive Bytecode specifies either a primitive in the primitive table (m=0) or an inlined primitive (m=1). Non-inlined primtiives from the primitive table have index (jjjjjjj * 256) + iiiiiiii and return from the method if they succeed.  This bytecode is only valid as the first bytecode of a method.  Inline primitives have index (jjjjjjj * 256) + iiiiiiii, cannot fail, and do not return when they succeed, yielding a result (typically on top of stack after popping their arguments, but possibly in a byte data stack, for example for unboxed floating-point primitives).</p><p>We sort the inline primitive operations by arity.  Nullary primitives occupy the 0-999 range.  Unary primitives occupy the 1-1999 range, etc.</p><p>We define the following inlined primitives: 1000unchecked class 1001unchecked pointer numSlots 1002unchecked pointer basicSize 1003unchecked byte8Type format numBytes (includes CompiledMethod) 1004unchecked short16Type format numShorts 1005unchecked word32Type format numWords 1006unchecked doubleWord64Type format numDoubleWords</p><p>2000unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #+.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (* depends on word size) 2001unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #-.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (* depends on word size) 2002unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #<em>.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (</em> depends on word size) 2003unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #/.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (* depends on word size) 2004unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #//.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (* depends on word size) 2005unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #\.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (* depends on word size) 2006unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #quo:.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (* depends on word size)</p><p>2016unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #bitAnd:.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (* depends on word size) 2017unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #bitOr:.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (* depends on word size) 2018unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #bitXor:.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (* depends on word size) 2019unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #bitShift:.  Both arguments are SmallIntegers and the result fits in a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> (* depends on word size)</p><p>2032unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #&gt;.  Both arguments are SmallIntegers 2033unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #&lt;.  Both arguments are SmallIntegers 2034unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #&gt;=.  Both arguments are SmallIntegers 2035unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #&lt;=.  Both arguments are SmallIntegers 2036unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #=.  Both arguments are SmallIntegers 2037unchecked <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> #~=.  Both arguments are SmallIntegers</p><p>2064unchecked Pointer Object&gt;&gt;at:.The receiver is guaranteed to be a pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> 2065unchecked Byte Object&gt;&gt;at:.The receiver is guaranteed to be a non-pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The result is a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>. 2066unchecked 16-bit Word Object&gt;&gt;at:.The receiver is guaranteed to be a non-pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The result is a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>. 2067unchecked Word Object&gt;&gt;at:.The receiver is guaranteed to be a non-pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The result is a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>. 2068unchecked DoubleWord Object&gt;&gt;at:.The receiver is guaranteed to be a non-pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The result is a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> or a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/LargePositiveInteger.html">LargePositiveInteger</a>. 2069unchecked QuadWord Object&gt;&gt;at:.The receiver is guaranteed to be a non-pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The result is a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> or a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/LargePositiveInteger.html">LargePositiveInteger</a>.</p><p>3000unchecked Pointer Object&gt;&gt;at:put:.The receiver is guaranteed to be a pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a> 3001unchecked Byte Object&gt;&gt;at:put:.The receiver is guaranteed to be a non-pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The argument is a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The primitive stores the least significant 8 bits. 3002unchecked Word Object&gt;&gt;at:put:.The receiver is guaranteed to be a non-pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The argument is a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The primitive stores the least significant 16 bits. 3003unchecked DoubleWord Object&gt;&gt;at:put:.The receiver is guaranteed to be a non-pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The argument is a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The primitive stores the least significant 32 bits. 3004unchecked QuadWord Object&gt;&gt;at:put:.The receiver is guaranteed to be a non-pointer object.  The 0-relative (1-relative?) index is an in-range <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The argument is a <a class="stClassLiteral" href="class/EncoderForSistaV1.html/class/SmallInteger.html">SmallInteger</a>.  The primitive stores the least significant 64 bits.</p></div></div><div class="classMethodDetail methodDetail"><h2 class="title">Class Method Details</h2></div><div class="instanceMethodDetail methodDetail"><h2 class="title">Instance Method Details</h2></div></div><script type="text/javascript">/*<![CDATA[*/function onLoad(){};/*]]>*/</script></body></html>