<html><head><title>BlockClosure</title><link rel="stylesheet" type="text/css" href="../files/common.css"/><link rel="stylesheet" type="text/css" href="../files/stcode.css"/><link rel="stylesheet" type="text/css" href="../files/style.css"/><link rel="stylesheet" type="text/css" href="../files/vtip.css"/><script>/*<![CDATA[*/
document.WEBDOC_RELATIVE_DOCUMENT_ROOT ="../..";
document.WEBDOC_PHARO_VERSION ="'4.0'";
/*]]>*/</script><script src="../files/jQuery.js"></script><script src="../files/jQueryUi.js"></script><script src="../files/app.js"></script></head><body onload="onLoad()"><div id="header"><form accept-charset="utf-8" method="get" action="/" class="hidden" id="search"><div class="searchInput">Search: <input accesskey="s" placeholder="search" name="4" id="search_box" size="30" value="" onkeyup="$.ajax({&quot;url&quot;:&quot;/&quot;,&quot;data&quot;:[&quot;1&quot;,&quot;2=&quot;+encodeURIComponent($(&quot;#search_box&quot;).val())].join(&quot;&amp;&quot;)});$(&quot;#searchResults&quot;).load(&quot;/&quot;,&quot;3&quot;)" type="search" class="search"/></div><div id="searchResults"></div><div></div></form></div><div id="content"><h1 class="className">BlockClosure</h1><dl class="box"><dt>Subclass of: </dt><dd><span class="inheritName"><a class="object_link class_link" target="classView" title="Object (class)" href="../class/Object.html">Object</a></span><ul class="fullTree"><li><a class="object_link class_link" target="classView" title="BlockClosure (class)" href="../class/BlockClosure.html">BlockClosure</a></li><li class="next"><a class="object_link class_link" target="classView" title="ProtoObject (class)" href="../class/ProtoObject.html">ProtoObject</a></li><li class="next"><a class="object_link class_link" target="classView" title="Object (class)" href="../class/Object.html">Object</a></li></ul><a class="inheritanceTree">&oplus;</a></dd></dl><br/><div class="classComment"><h2 class="title">Overview</h2><div class="docString"><p>I contain a sequence of operations. I am defined by <a class="stGlobalLiteral" href="class/BlockClosure.html/class/SmalltalkImage.html">Smalltalk</a> expressions inside square brackets. I permit to defer the enclosed operations until I execute a variant of #value. I can have my own arguments and temporaries as a regular method, but I am also able to use external variables: my enclosing method or block temporaries, arguments and receiver.</p><p>examples : <a>1 + 2 </a> value <a>:arg | 	| temp | 	temp := arg. 	temp </a> value: 5 <a>^ 5 </a> value</p><p>My return value corresponds to my final expression. A non local return (^) has the same effect as if I did not exist: it returns from my enclosing method, even if I'm nested in other blocks. </p><p>Implementation:</p><p>Instance variables: outerContext <a href="Context|nil"></a> context that defined me startpc: <a href="SmallInteger"></a> (pc = program counter) offset of my first bytecode instruction in the compiledMethod bytecode<br/>numArgs: <a href="SmallInteger"></a> my number of arguments</p><p>I am created at runtime through a special bytecode: closureNumCopied: x numArgs: y bytes z1 to z2 On creation, the currently executed context is set to my outerContext, z1 is set as my startpc and y is set as my numArgs. After my creation, the current execution flow jumps to my last bytecode, z2, to skip the execution of my bytecode which is deferred until I execute a variant of #value.</p><p>I am executed when I receive a variant of the message value. This message creates a new context, a block context <a href="MethodContext"></a>, which reference me in its variable closureOrNil. This new context executes my bytecode, which correspond to a subset of the bytecode of my enclosing method, starting at startpc and ending in blockReturn/return bytecode.</p><p>Accessing variables of the my enclosing context is different depending on variables because of various optimizations: - self: I access the receiver of my enclosing method by accessing my context's receiver, which is always set to the enclosing method receiver. - copied variables: If I read a variable from an outerContext but I don't write into it and the variable is not modified after the <a class="stClassLiteral" href="class/BlockClosure.html/class/BlockClosure.html">BlockClosure</a> creation, then the variable is copied in the blockClosure to be more efficient. - full variable: If I access and edit a variable from an outerContext, then the variable is stored in an external heap allocated array (named tempVector). The tempVector is known by the method and the block so they can both read and write these variables.</p><p>Optimized block closures: Common blocks (2/3 of the blocks) are optimized directly in the compiler and have special behaviors. These blocks are the arguments/receiver of control structures: #ifNil:, #ifNotNil:, #ifTrue:, #ifFalse:, #whileTrue:, #whileFalse:, #to:do:, #to:by:do: .</p></div></div><div class="classMethodDetail methodDetail"><h2 class="title">Class Method Details</h2></div><div class="instanceMethodDetail methodDetail"><h2 class="title">Instance Method Details</h2></div></div><script type="text/javascript">/*<![CDATA[*/function onLoad(){};/*]]>*/</script></body></html>