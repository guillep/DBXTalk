<html><head><title>AndreasSystemProfiler</title><link rel="stylesheet" type="text/css" href="../files/common.css"/><link rel="stylesheet" type="text/css" href="../files/stcode.css"/><link rel="stylesheet" type="text/css" href="../files/style.css"/><link rel="stylesheet" type="text/css" href="../files/vtip.css"/><script>/*<![CDATA[*/
document.WEBDOC_RELATIVE_DOCUMENT_ROOT ="../..";
document.WEBDOC_PHARO_VERSION ="'4.0'";
/*]]>*/</script><script src="../files/jQuery.js"></script><script src="../files/jQueryUi.js"></script><script src="../files/app.js"></script></head><body onload="onLoad()"><div id="header"><form accept-charset="utf-8" method="get" action="/" class="hidden" id="search"><div class="searchInput">Search: <input accesskey="s" placeholder="search" name="4" id="search_box" size="30" value="" onkeyup="$.ajax({&quot;url&quot;:&quot;/&quot;,&quot;data&quot;:[&quot;1&quot;,&quot;2=&quot;+encodeURIComponent($(&quot;#search_box&quot;).val())].join(&quot;&amp;&quot;)});$(&quot;#searchResults&quot;).load(&quot;/&quot;,&quot;3&quot;)" type="search" class="search"/></div><div id="searchResults"></div><div></div></form></div><div id="content"><h1 class="className">AndreasSystemProfiler</h1><dl class="box"><dt>Subclass of: </dt><dd><span class="inheritName"><a class="object_link class_link" target="classView" title="Object (class)" href="../class/Object.html">Object</a></span><ul class="fullTree"><li><a class="object_link class_link" target="classView" title="AndreasSystemProfiler (class)" href="../class/AndreasSystemProfiler.html">AndreasSystemProfiler</a></li><li class="next"><a class="object_link class_link" target="classView" title="ProtoObject (class)" href="../class/ProtoObject.html">ProtoObject</a></li><li class="next"><a class="object_link class_link" target="classView" title="Object (class)" href="../class/Object.html">Object</a></li></ul><a class="inheritanceTree">&oplus;</a></dd></dl><br/><div class="classComment"><h2 class="title">Overview</h2><div class="docString"><p><a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/AndreasSystemProfiler.html">AndreasSystemProfiler</a> uses sub-msec VM supported PC sampling.</p><div class="code">In Memory of Andreas Raab.  Author, Friend, Colleague. 	http://forum.world.st/In-Memory-of-Andreas-Raab-td4663424.htmlReleased by Ron, Julie and David</div>&nbsp;<p>Example: <a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/AndreasSystemProfiler.html">AndreasSystemProfiler</a> spyOn: <a>10000 timesRepeat: [ 3.14159 printString </a> ]</p><p>-=-=-=-=-=-=-= Apparently, the time taken to run the provided block is as twice as long as run without the profiler.</p><p>-=-=-=-=-=-=-= Both <a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/AndreasSystemProfiler.html">AndreasSystemProfiler</a> and <a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/MessageTally.html">MessageTally</a> are periodic sampling profilers.  The essential difference between <a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/AndreasSystemProfiler.html">AndreasSystemProfiler</a> and <a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/MessageTally.html">MessageTally</a> is in how the current method is sampled.</p><p><a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/MessageTally.html">MessageTally</a> is driven from a high-priority process in a loop waiting on a delay.  When the delay fires the lower-priority process being profiled is interrupted, its stack is walked to determine the methods along the call chain, and that data is recorded.  But since the sampling occurs when the high-priority process preempts the lower-priority process, a sample is only taken at a preemption point.  In particular, primitives are <em>not</em> profiled because they are not suspension points.  A process can only be suspended on method activation (a non-primitive method activation, or primitive failure) or on backward branch.  The cost of primitives is charged to a caller and is inferred by subtracting the cost of children of the caller from the caller itself (subtracting the number of samples in children of the caller form the number of samples in the caller itself).  </p><p>Another problem is that using the clock that underlies <a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/Delay.html">Delay</a>, which is typically the clock used by processes being profiled, causes sampling errors due to the sampling and sampled processes cohering.  Delays are limited in resolution (at best 1 millisecond) so if the profiled process waits on a delay it'll fire immediately after the profiling process (because the profiling process is at higher priority) and so the sampling process may only ever see the sampled process in a wait state.</p><p>If <a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/MessageTally.html">MessageTally</a> is used to profile multiple processes then a third problem is that if a primitive causes a process switch then its cost will end up being charged to the process switched-to, not switched from.  This is again because sampling can only occur after a primitive has completed (successfully or not).</p><p><a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/AndreasSystemProfiler.html">AndreasSystemProfiler</a> is driven from a high-priority process in a loop waiting on a <a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/Semaphore.html">Semaphore</a> known to the VM.  The profiling process uses a primitive to schedule a sample some number of ticks of the VM's high-performance clock in the future.  When the time is reached the VM samples the current method and the current process, <em>before any process preemption takes place</em>, and independently of the standard clock, and signals the semaphore.  The profiling process then collects the method,process pair via primitives.  So <a class="stClassLiteral" href="class/AndreasSystemProfiler.html/class/AndreasSystemProfiler.html">AndreasSystemProfiler</a> provides much more accurate results.</p><p>That said there are still limitations with primitives and Cog.  Currently Cog only samples &quot;interpreter&quot; primitives.  Those primitives it implements in machine code (integer and float arithmetic, closure evaluation, <a class="stSelector" href="class/AndreasSystemProfiler.html/class/GAResultSet.html#method/at%253A">at:</a>, identityHash) are not sampled and won't show up; they will be charged to the calling method.  This is fixable, since Cog actually compiles the sampling direct into interpreter primitive invocation when profiling is in effect and not at other times, but sampling could be a significant cost in these simple and performance-critical primitives.</p></div></div><div class="classMethodDetail methodDetail"><h2 class="title">Class Method Details</h2></div><div class="instanceMethodDetail methodDetail"><h2 class="title">Instance Method Details</h2></div></div><script type="text/javascript">/*<![CDATA[*/function onLoad(){};/*]]>*/</script></body></html>